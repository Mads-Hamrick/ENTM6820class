---
title: "2025_3_20_DataWrangling_mer0127"
author: "Madeline Redd"
date: "`r format(Sys.time(), '%Y - %m - %d')`"
output:
  pdf_document:
  html_document:
  word_document:
  keep_md: yes
---

Seamless Data Wrangling
----------------------------------------------------------------------------------------------------------------------------------- 
  
Manipulating data, Adding new columns, Working with large messy data set

Installing and loading in the tidyverse package. Attaches core tidyverse packages. Tidyverse allows easier work for large data sets.  

#### R script Setup Code Explained

  1. include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
  2. echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
  3. message = FALSE prevents messages that are generated by code from appearing in the finished file.
  4. warning = FALSE prevents warnings that are generated by code from appearing in the finished.
  5. fig.cap = "..." adds a caption to graphical results.

```{r, label = 'Packages', warning = FALSE}


library(tidyverse)

```

More info and cheat sheets can be found here: [Tidyverse] (https://tidyr.tidyverse.org/index.html)
Lets demonstrate some of the most useful functionality of some tidyverse functions. Note that this tutorial does not cover everything and self-learning may be required for specific functionality.  

Goals to learn from the Assignment:

Data wrangling & manipulation  
    – mutate()    
    – select()  
    – filter()  
    – the pipe %>%  
    – summarise()  
    – group_by()  
    – joining  
    – pivotting  
    – Integration with plotting  


Loading in the file "Bull_richness.csv". This contains information crops Corn and Soy that includes all fungi in the Phylum Ascomycota. In this assignment the goal is to look at how Fungicide variable impacts richness.

```{r echo=TRUE, results='hide'}

microbiome.fungi <- read.csv("Project_Data_Files/Bull_richness.csv") 
                                        #hid results to clean up output in pdf

head(microbiome.fungi)        #Shows column names and the first 6 rows of data
str(microbiome.fungi)

```

## Select Function `select ()`

#### Example of function use broken down:

newdataframe <- select(data, column_name_wanted, column_name_wanted, column_range_first : column_range_last, column_name_wanted)

```{r}

microbiome.fungi2 <- select(microbiome.fungi, SampleID, Crop, 
                            Compartment:Fungicide, richness)
str(microbiome.fungi2)

```

## Filter Function `filter()`

#### Example of Function

head(filter(data, column_name == "Value"))

Similar coding to `subset()` function

```{r}

head(filter(microbiome.fungi2, Treatment == "Conv."))

head(filter(microbiome.fungi2, Treatment == "Conv." & Fungicide == "C")) 
                                             #variable value & variable value

head(filter(microbiome.fungi2, Sample == "A" | Sample == "B")) 
                                            #variable value OR variable value

```

## Mutate Function `mutate()`

#### Example of Function
mutate(data, new_column = any_function(old_column_to_manipulate))

```{r}

microbiome.fungi2$logRich <- log(microbiome.fungi2$richness)    
                         #Creating a new column called logRich using $ symbol

head(mutate(microbiome.fungi2, logRich = log(richness)))

head(mutate(microbiome.fungi2, Crop_Treatment = paste(Crop, Treatment)))    
                      #Creating a new column that combines Crop and Treatment 

```

## Pipe Function `%>%`

Allows to combine multiple functions together to wrangle the data into a specific form for a new data frame. The data from the previous step is transferred to the next step. 

```{r echo=TRUE, results='hide'}
select(microbiome.fungi, SampleID, Crop, Compartment:Fungicide, richness) 
                                             #hid results to clean up document
```


```{r}
microbiome.fungi %>%    #DATA
  select(SampleID, Crop, Compartment:Fungicide, richness) %>%     
                                                        #Selecting out columns
  filter(Treatment == "Conv.") %>%    
                            #Filtering out the data for a specific requirement
  mutate(logRich = log(richness)) %>%     
                                  #Creating a new column for the log(richness)
  head() 
```

## Summarise Function `summarise()`

#### Example of Function

summarise(new_column_name = math_function(old_column))

The `summarise()` function allows for calculations like mean, standard deviation, and standard error. 

```{r}
microbiome.fungi %>%
  select(SampleID, Crop, Compartment:Fungicide, richness) %>% 
                                                            #Selecting columns
  filter(Treatment == "Conv.") %>% 
                        #Subsetting to only include the conventional treatment
  mutate(logRich = log(richness)) %>% 
                                    #Creating a new column of the log richness
  summarise(Mean.rich = mean(logRich))  #Calculating overall mean log richness
                      

```

Adding more lines of code to perform more calculations.

```{r}

microbiome.fungi %>%
  select(SampleID, Crop, Compartment:Fungicide, richness) %>%       
                                                  #Selecting Specific Columns
  filter(Treatment == "Conv.") %>%           
  #Filtering the data where Treatment equals Conventional Treatment ("Conv.")
  mutate(logRich = log(richness)) %>%        
                               #Again adding a new column of the log richness
  summarise(Mean.rich = mean(logRich),       
                #Calculating the Mean, Standard Deviation, and Standard Error
            n = n(), 
            sd.dev = sd(logRich)) %>%
  mutate(std.err = sd.dev/sqrt(n))

```

## Group_by Function `group_by()` 

### Example of Group_by Function

dataframe %>%
group_by (column, column)

```{r}
microbiome.fungi %>%
  select(SampleID, Crop, Compartment:Fungicide, richness) %>% 
  group_by(Treatment, Fungicide) %>%          
                                  #Groups the data by treatment and fungicide
  mutate(logRich = log(richness)) %>% 
  summarise(Mean.rich = mean(logRich), 
            n = n(), 
            sd.dev = sd(logRich)) %>%
  mutate(std.err = sd.dev/sqrt(n))
```

#### Connecting to Plotting

Great for directly plotting into ggplot function. This will be great for project data and final project.

```{r}

microbiome.fungi %>%
  select(SampleID, Crop, Compartment:Fungicide, richness) %>% 
  group_by(Treatment, Fungicide) %>% 
  mutate(logRich = log(richness)) %>% 
  summarise(Mean.rich = mean(logRich), 
            n = n(), 
            sd.dev = sd(logRich)) %>%
  mutate(std.err = sd.dev/sqrt(n)) %>%
  ggplot(aes(x = Fungicide, y = Mean.rich)) + 
        #Adding GGPLOT function, treated like normal, but not dataframe input
  geom_bar(stat="identity") +
  geom_errorbar( aes(x=Fungicide, ymin=Mean.rich-std.err, 
                     ymax=Mean.rich+std.err), width=0.4) +
  theme_minimal() +
  xlab("") +
  ylab("Log Richness") +
  facet_wrap(~Treatment)

```

#### Joining Functions

[Dplyr] (https://dplyr.tidyverse.org/reference/mutate-joins.html) 

  -`left_join()`: Keep all rows of X and add matching rows from Y. Any rows in Y that don’t match X are excluded.
  -`right_join()`: reverse of left_join()
  -`inner_join()`: only keep rows that are common to both X AND Y, remove everything else. 
  -`full_join()`: Keep any columns that are in either X or Y
    

Sample_n Function `sample_n()` 

```{r}

Richness <- microbiome.fungi %>%
  select(SampleID, richness)

Metadata <- microbiome.fungi %>% 
  select(SampleID, Fungicide, Crop, Compartment, GrowthStage, Treatment, 
         Rep, Sample)

head(Metadata)
head(Richness)

head(left_join(Metadata, Richness, by = "SampleID")) 
                        #Adding the richness data to the metadata based on on 
                                               #the common column of sampleID

```

## Pivoting Function

Pivoting is also useful for converting from wide to long format and back again. Functions called `pivot_longer()` and `pivot_wider()`

[Tidyverse] (https://tidyr.tidyverse.org/reference/pivot_wider.html) 

### Example of Function
`pivot_wider()` 

Wide Format: sets the values within the fungicide column into column names

names_from and values_from: A pair of arguments describing which column (or columns) to get the name of the output column (names_from), and which column (or columns) to get the cell values from (values_from).

```{r}
microbiome.fungi %>%
  select(SampleID, Crop, Compartment:Fungicide, richness) %>%  
  group_by(Treatment, Fungicide) %>% 
  summarise(Mean = mean(richness)) %>% 
  pivot_wider(names_from = Fungicide, values_from = Mean) #Pivot to wide format
```

Calculating the difference between the fungicide and control.

```{r}
microbiome.fungi %>%
  select(SampleID, Crop, Compartment:Fungicide, richness) %>% 
  group_by(Treatment, Fungicide) %>% 
  summarise(Mean = mean(richness)) %>%  
  pivot_wider(names_from = Fungicide, values_from = Mean) %>% 
  mutate(diff.fungicide = C - F) 
```

Now plotting the calculated data.

```{r}
microbiome.fungi %>%
  select(SampleID, Crop, Compartment:Fungicide, richness) %>% 
  group_by(Treatment, Fungicide) %>% 
  summarise(Mean = mean(richness)) %>%  
  pivot_wider(names_from = Fungicide, values_from = Mean) %>% 
  mutate(diff.fungicide = C - F) %>%  
  ggplot(aes(x = Treatment, y = diff.fungicide)) +  
  geom_col() +
  theme_minimal() +
  xlab("") +
  ylab("Difference in average species richness")
```


